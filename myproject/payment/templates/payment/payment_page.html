{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата замовлення | PrometeyLabs</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Підключення власних стилів -->
    <link rel="stylesheet" href="{% static 'payment/css/style.css' %}">
</head>
<body>
    <div class="container">
        <!-- Логотип -->
        <div class="logo">
            <div class="logo-text">Prometey<span>Labs</span></div>
        </div>

        <h1>Деталі вашого замовлення</h1>

        {% if expires_at_iso %}
            <div id="countdown-timer">Часу на оплату залишилось: <span id="timer"></span></div>
        {% endif %}

        <div class="info-section payment-details">
            <h2>Інформація про платіж:</h2>
            <p><strong>Опис:</strong> {{ payment_link.description }}</p>
            <p><strong>Сума до сплати:</strong> {{ payment_link.amount }} {{ payment_link.currency }}</p>
            <p><strong>Статус:</strong> {{ payment_link.get_status_display }}</p>
            {% if payment_link.expires_at %}
            <p><strong>Дійсне до:</strong> {{ payment_link.expires_at|date:"d.m.Y H:i:s T" }}</p>
            {% endif %}
        </div>

        <div class="info-section company-info">
            <h2>Інформація про компанію:</h2>
            <div class="company-description">
                <p>PrometeyLabs — це українська ІТ-компанія, що спеціалізується на швидкій розробці вебпродуктів, автоматизації процесів, інтеграції ШІ та чат-ботів. Ми працюємо швидко, без зайвих витрат та з фокусом на якість.</p>
                
                <p><strong>Основні напрямки:</strong><br>
                Розробка сайтів та платформ<br>
                AI-аватари, чат-боти, телеграм-боти<br>
                E-commerce рішення</p>
                
                <p>ФОП Дмитренко Софія Дмитрівна, зареєстровано в Україні, платник єдиного податку 3 групи.</p>
            </div>
        </div>

        {% if payment_link.payment_instructions %}
        <div class="info-section payment-instructions">
            <h2>Інструкції з оплати:</h2>
            <div>{{ payment_link.payment_instructions|safe }}</div>
        </div>
        {% endif %}

        <div class="info-section payment-form">
            <h2>Форма оплати:</h2>
            
            <p><strong>Реквізити для оплати:</strong></p>
            
            <div class="requisites-field">
                <span>ФОП <strong>Дмитренко Софія Дмитрівна</strong></span>
                <button class="copy-btn" data-copy="Дмитренко Софія Дмитрівна">Копіювати</button>
            </div>
            
            <div class="requisites-field">
                <span>ІПН: <strong>3770706565</strong></span>
                <button class="copy-btn" data-copy="3770706565">Копіювати</button>
            </div>
            
            <div class="requisites-field">
                <span>IBAN: <strong>UA633220010000026003350084660</strong></span>
                <button class="copy-btn" data-copy="UA633220010000026003350084660">Копіювати</button>
            </div>
            
            <div class="requisites-field">
                <span>Акціонерне товариство УНІВЕРСАЛ БАНК, МФО: 322001</span>
            </div>
            
            <div class="requisites-field">
                <span>Призначення платежу: <strong>Оплата за {{ payment_link.description }}</strong></span>
                <button class="copy-btn" data-copy="Оплата за {{ payment_link.description }}">Копіювати</button>
            </div>
            
            <p><em>(Тут буде інтеграція з платіжною системою)</em></p>
            <!-- Заглушка для кнопки оплати -->
            <a href="#" class="button button-primary">Оплатити {{ payment_link.amount }} {{ payment_link.currency }}</a>
        </div>

        {% if payment_link.contract_file %}
        <div class="info-section contract-link">
            <h2>Договір:</h2>
            <p><a href="{{ payment_link.contract_file.url }}" target="_blank" class="button button-secondary">Завантажити договір (PDF)</a></p>
            
            <div class="signature-container">
                <div class="signature-header">
                    <h3>Підписати договір онлайн</h3>
                    <small>Має юридичну силу згідно ЗУ "Про електронні довірчі послуги"</small>
                </div>
                
                <div class="signature-input">
                    <input type="text" id="signatureName" placeholder="Введіть ваше повне ім'я" />
                    <button class="button button-secondary" id="confirmName">Підтвердити</button>
                </div>
                
                <canvas id="signatureCanvas" class="signature-pad" width="800" height="200"></canvas>
                
                <div class="signature-actions">
                    <button class="button button-secondary" id="clearSignature">Очистити</button>
                    <button class="button button-primary" id="saveSignature">Підписати документ</button>
                </div>
                
                <div class="signature-info">
                    Поставте підпис мишкою або пальцем (на сенсорному пристрої). Підписаний документ буде надіслано на вашу електронну пошту.
                </div>
                
                <img id="signaturePreview" class="signature-preview" alt="Підпис" />
            </div>
        </div>
        {% endif %}

        <div class="footer">
            <p><small>Унікальний ID посилання: {{ payment_link.unique_id }}</small></p>
            <p><small>&copy; 2025 PrometeyLabs. Всі права захищено.</small></p>
        </div>
    </div>

    {% if expires_at_iso %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const countDownDate = new Date("{{ expires_at_iso }}").getTime();
            const timerElement = document.getElementById("timer");
            const timerContainer = document.getElementById("countdown-timer");

            if (!timerElement) return;

            const x = setInterval(function() {
                const now = new Date().getTime();
                const distance = countDownDate - now;

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                let timerText = "";
                if (days > 0) timerText += days + "д ";
                if (hours > 0 || days > 0) timerText += hours + "г ";
                if (minutes > 0 || hours > 0 || days > 0) timerText += minutes + "хв ";
                timerText += seconds + "с";
                
                timerElement.innerHTML = timerText;

                if (distance < 0) {
                    clearInterval(x);
                    timerElement.innerHTML = "ЧАС ВИЙШОВ";
                    timerContainer.style.backgroundColor = "#e9ecef";
                    timerContainer.style.borderColor = "#ced4da";
                    timerContainer.style.color = "#495057";
                    // Тут можна додати логіку для блокування форми оплати або перезавантаження сторінки
                    // Наприклад: window.location.reload();
                }
            }, 1000);
        });
    </script>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Додаємо функціонал кнопкам копіювання
            const copyButtons = document.querySelectorAll('.copy-btn');
            
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const textToCopy = this.getAttribute('data-copy');
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            // Зміна тексту кнопки на підтвердження
                            const originalText = this.innerText;
                            this.innerText = 'Скопійовано!';
                            this.classList.add('copy-success');
                            
                            // Повернення оригінального тексту через 2 секунди
                            setTimeout(() => {
                                this.innerText = originalText;
                                this.classList.remove('copy-success');
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Помилка копіювання: ', err);
                        });
                });
            });

            // Код для підпису договору
            const canvas = document.getElementById('signatureCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                const signaturePreview = document.getElementById('signaturePreview');
                const signatureName = document.getElementById('signatureName');
                const confirmNameBtn = document.getElementById('confirmName');
                const clearBtn = document.getElementById('clearSignature');
                const saveBtn = document.getElementById('saveSignature');
                
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;
                let nameConfirmed = false;
                
                // Налаштування стилю лінії
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#000';
                
                // Очищення полотна та встановлення повідомлення
                function clearCanvas() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '20px Arial';
                    ctx.fillStyle = '#ccc';
                    ctx.textAlign = 'center';
                    ctx.fillText('Поставте тут ваш підпис', canvas.width / 2, canvas.height / 2);
                }
                
                // Ініціалізація
                clearCanvas();
                
                // Функція для початку малювання
                function startDrawing(e) {
                    if (!nameConfirmed) {
                        alert('Спочатку введіть та підтвердіть ваше ім\'я');
                        return;
                    }
                    
                    isDrawing = true;
                    [lastX, lastY] = getCoordinates(e);
                }
                
                // Функція для отримання координат з різних типів подій
                function getCoordinates(e) {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    
                    if (e.type.includes('touch')) {
                        return [
                            (e.touches[0].clientX - rect.left) * scaleX,
                            (e.touches[0].clientY - rect.top) * scaleY
                        ];
                    } else {
                        return [
                            (e.clientX - rect.left) * scaleX,
                            (e.clientY - rect.top) * scaleY
                        ];
                    }
                }
                
                // Функція для малювання
                function draw(e) {
                    if (!isDrawing) return;
                    e.preventDefault();
                    
                    const [currentX, currentY] = getCoordinates(e);
                    
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(currentX, currentY);
                    ctx.stroke();
                    
                    [lastX, lastY] = [currentX, currentY];
                }
                
                // Функція завершення малювання
                function stopDrawing() {
                    isDrawing = false;
                }
                
                // Функція для збереження підпису
                function saveSignature() {
                    if (!nameConfirmed) {
                        showModal('Помилка', 'Спочатку введіть та підтвердіть ваше ім\'я');
                        return;
                    }
                    
                    // Перевірка наявності підпису
                    const pixelData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    let hasSignature = false;
                    
                    for (let i = 0; i < pixelData.length; i += 4) {
                        if (pixelData[i + 3] > 0) {
                            hasSignature = true;
                            break;
                        }
                    }
                    
                    if (!hasSignature) {
                        showModal('Помилка', 'Будь ласка, поставте підпис перед збереженням');
                        return;
                    }
                    
                    // Додавання імені до підпису
                    const name = signatureName.value.trim();
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#000';
                    ctx.textAlign = 'right';
                    ctx.fillText(name, canvas.width - 10, canvas.height - 10);
                    
                    // Конвертація підпису в зображення
                    const signatureImage = canvas.toDataURL('image/png');
                    signaturePreview.src = signatureImage;
                    signaturePreview.style.display = 'block';
                    
                    // Показуємо стилізоване модальне вікно
                    showModal('Підтвердите дійствие на ' + window.location.hostname, 'Дякуємо! Ваш підпис збережено. Підписаний документ буде надіслано на вашу електронну пошту.');
                    
                    // Відправка даних на сервер (заглушка)
                    console.log('Signature data:', signatureImage);
                    console.log('Signature name:', name);
                    console.log('Document ID:', '{{ payment_link.unique_id }}');
                    
                    // Тут би був код для передачі даних на сервер
                    // fetch('/sign-document/', {
                    //     method: 'POST',
                    //     body: JSON.stringify({
                    //         signature: signatureImage,
                    //         name: name,
                    //         documentId: '{{ payment_link.unique_id }}'
                    //     }),
                    //     headers: {
                    //         'Content-Type': 'application/json',
                    //         'X-CSRFToken': getCookie('csrftoken')
                    //     }
                    // }).then(response => response.json())
                    //   .then(data => console.log('Success:', data))
                    //   .catch(error => console.error('Error:', error));
                }
                
                // Обробник для підтвердження імені
                confirmNameBtn.addEventListener('click', function() {
                    const name = signatureName.value.trim();
                    if (name.length < 5) {
                        showModal('Помилка', 'Будь ласка, введіть ваше повне ім\'я');
                        return;
                    }
                    
                    nameConfirmed = true;
                    signatureName.disabled = true;
                    confirmNameBtn.disabled = true;
                    
                    // Очистка полотна для підпису
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    canvas.style.borderColor = '#007bff';
                    
                    // Додавання підказки
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#007bff';
                    ctx.textAlign = 'center';
                    ctx.fillText('Тепер поставте ваш підпис тут', canvas.width / 2, canvas.height / 2);
                });
                
                // Додавання слухачів подій для підпису
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('touchstart', startDrawing);
                
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('touchmove', draw);
                
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('touchend', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                
                clearBtn.addEventListener('click', clearCanvas);
                saveBtn.addEventListener('click', saveSignature);
            }
            
            // Функції для роботи з модальним вікном
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalOkBtn = document.getElementById('modalOkBtn');
            
            // Функція відображення модального вікна
            function showModal(title, message) {
                if (modal) {
                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    modal.style.display = 'flex';
                    
                    // Обробник для закриття вікна при кліку на кнопку
                    modalOkBtn.onclick = function() {
                        closeModal();
                    };
                    
                    // Закрити при кліку поза вікном
                    window.onclick = function(event) {
                        if (event.target == modal) {
                            closeModal();
                        }
                    };
                }
            }
            
            // Функція закриття модального вікна
            function closeModal() {
                modal.style.display = 'none';
            }
        });
    </script>
    
    <!-- Стилізоване модальне вікно для повідомлень -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Підтвердите дійствие</h3>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Дякуємо! Ваш підпис збережено. Підписаний документ буде надіслано на вашу електронну пошту.</p>
            </div>
            <div class="modal-footer">
                <button id="modalOkBtn" class="button button-primary">OK</button>
            </div>
        </div>
    </div>
</body>
</html> 